# Sweepza v2.7 - Enhanced Master Control System

## ğŸ›ï¸ What's New

v2.7 introduces a **comprehensive sheet-based control system** that gives you complete control over every aspect of the pipeline without touching code.

---

## ğŸ–¥ï¸ Master Control Panel

### Location
`Sweepza_Control` sheet - your primary dashboard

### Features

#### ğŸ“Š Visual Dashboard
- Clean, organized layout with color-coded sections
- Real-time system status monitoring
- Quick action buttons
- Configuration sheet links

#### âš™ï¸ Pipeline Controls

| Setting | Type | Description | Default |
|---------|------|-------------|---------|
| **DELETE_EXPIRED** | Boolean | Auto-delete expired entries in Stage 1 | FALSE |
| **ENABLE_MASTER_QA** | Boolean | Run LLM QA check on Master before export | TRUE |
| **DRY_RUN** | Boolean | Test mode - no writes to sheets | FALSE |
| **FORCE_FULL_REFRESH** | Boolean | Reprocess ALL rows (ignore llm_processed flags) | FALSE |
| **SKIP_LLM_ENRICHMENT** | Boolean | Skip Stage 2 LLM enrichment entirely | FALSE |

**How to use**:
1. Open `Sweepza_Control` sheet
2. Find the setting in column A
3. Change column B value to TRUE or FALSE
4. Run `sweepzaPipeline()` - changes take effect immediately

---

## ğŸš€ Quick Actions

New callable functions you can run directly from Apps Script or link to buttons:

### 1. `refreshSourceMapManual()`
**Purpose**: Re-scan all sheets and detect headers without running full pipeline

**When to use**:
- After adding new source sheets
- After changing header rows
- To verify sheet detection

**What it does**:
- Scans all non-system sheets
- Detects header row automatically
- Preserves your enabled/disabled settings
- Updates header preview in Source Map

**How to run**:
```javascript
// From Apps Script editor:
refreshSourceMapManual()
```

---

### 2. `clearLlmCache()`
**Purpose**: Force re-enrichment of all rows (clears llm_processed flags)

**When to use**:
- Changed LLM prompts and want to regenerate all descriptions
- Switched LLM models (gpt-4o-mini â†’ gpt-4o)
- Need fresh enrichment for all entries

**Warning**: âš ï¸ This will consume OpenAI credits to re-enrich ALL rows

**What it does**:
- Clears `llm_processed` column in all source sheets
- Shows confirmation dialog before proceeding
- Reports how many sheets were cleared
- Next pipeline run will re-enrich everything

**How to run**:
```javascript
// From Apps Script editor:
clearLlmCache()
```

---

### 3. `exportMasterToCsv()`
**Purpose**: Download Master sheet as CSV file

**When to use**:
- Need CSV export for Wix import
- Want backup of Master data
- Sharing data with external tools

**What it does**:
- Exports entire Master_Export_Sheet to CSV
- Properly escapes commas, quotes, newlines
- Saves to same Google Drive folder as spreadsheet
- Shows file name and location in success dialog

**Output format**:
- Filename: `Sweepza_Master_Export_YYYY-MM-DD_HHMMSS.csv`
- Location: Same folder as your Google Sheet
- Encoding: UTF-8

**How to run**:
```javascript
// From Apps Script editor:
exportMasterToCsv()
```

---

## ğŸ“ˆ System Status (Real-Time Monitoring)

The Control Panel now displays live system metrics:

| Metric | What it shows | Auto-updates |
|--------|---------------|--------------|
| **Last Pipeline Run** | Timestamp of most recent execution | After each run |
| **Enabled Source Sheets** | Count of sheets currently being processed | When Source Map changes |
| **Master Export Rows** | Total rows in Master_Export_Sheet | After each run |
| **LLM Queue Size** | Rows awaiting LLM enrichment | Planned (currently N/A) |

---

## ğŸ”§ Configuration Sheets (Unchanged)

All existing configuration remains in specialized sheets:

### `Sweepza_Master_Adjust`
**What you can control**:
- âœ… LLM prompts (enrich_prompt, qa_prompt)
- âœ… Schema mappings (source â†’ master headers)
- âœ… Tag precedence (which tags to prioritize)
- âœ… Social media domains
- âœ… Limits (maxLlmRowsPerRun, maxRetries, etc.)
- âœ… Validation settings (fuzzy dedup, URL validation)
- âœ… Operator controls (email notifications, backups, cost tracking)

**How to edit**:
1. Open `Sweepza_Master_Adjust`
2. Find the section (SECTION column in KV table)
3. Edit VALUE column
4. Changes take effect on next `sweepzaPipeline()` run

### `Sweepza_Source_Map`
**What you can control**:
- âœ… Enable/disable any source sheet (enabled column)
- âœ… Set custom header row number (header_row column)
- âœ… Add notes for each sheet

**How to use**:
1. Run `sweepzaSetup()` or `refreshSourceMapManual()` to populate
2. Set `enabled = TRUE` for sheets you want to process
3. Set `enabled = FALSE` to skip a sheet
4. If headers aren't detected correctly, manually set `header_row` number

---

## ğŸ’¡ Common Workflows

### Workflow 1: Add a new source sheet
```
1. Import CSV to new sheet (e.g., "New_Source")
2. Run refreshSourceMapManual()
3. Open Sweepza_Source_Map
4. Find "New_Source" in list
5. Set enabled = TRUE
6. Verify header_row and detected_headers_preview look correct
7. Run sweepzaPipeline()
```

### Workflow 2: Change LLM prompts and regenerate all
```
1. Open Sweepza_Master_Adjust
2. Edit enrich_prompt or qa_prompt text
3. Save changes
4. Run clearLlmCache()
5. Confirm the warning dialog
6. Run sweepzaPipeline()
7. All rows will be re-enriched with new prompts
```

### Workflow 3: Test changes without modifying data
```
1. Open Sweepza_Control
2. Set DRY_RUN = TRUE
3. Run sweepzaPipeline()
4. Check Sweepza_Logs for what WOULD happen
5. No actual writes occur
6. Set DRY_RUN = FALSE when ready
7. Run sweepzaPipeline() for real
```

### Workflow 4: Skip LLM to save credits
```
1. Open Sweepza_Control
2. Set SKIP_LLM_ENRICHMENT = TRUE
3. Run sweepzaPipeline()
4. Stages 1, 3, 4, 5 will run
5. Stage 2 (LLM enrichment) is skipped
6. Useful for bulk imports without enrichment
```

### Workflow 5: Force refresh all rows
```
1. Open Sweepza_Control
2. Set FORCE_FULL_REFRESH = TRUE
3. Run sweepzaPipeline()
4. ALL rows reprocess regardless of llm_processed flag
5. Use when: changed prompts, switched models, or need clean slate
6. Warning: Will consume LLM credits for all rows
7. Set back to FALSE after one run
```

---

## ğŸ¨ Control Panel Layout

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ›ï¸ SWEEPZA MASTER CONTROL PANEL v2.7                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  PIPELINE CONTROLS                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Setting                â”‚ Value   â”‚ Type    â”‚ Descr...  â”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚ DELETE_EXPIRED         â”‚ FALSE   â”‚ Boolean â”‚ Auto-...  â”‚ â”‚
â”‚  â”‚ ENABLE_MASTER_QA       â”‚ TRUE    â”‚ Boolean â”‚ Run LLM...â”‚ â”‚
â”‚  â”‚ DRY_RUN                â”‚ FALSE   â”‚ Boolean â”‚ Test mo...â”‚ â”‚
â”‚  â”‚ FORCE_FULL_REFRESH     â”‚ FALSE   â”‚ Boolean â”‚ Reproce...â”‚ â”‚
â”‚  â”‚ SKIP_LLM_ENRICHMENT    â”‚ FALSE   â”‚ Boolean â”‚ Skip St...â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                              â”‚
â”‚  QUICK ACTIONS                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Action         â”‚ Command              â”‚ Description   â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚ Run Pipeline   â”‚ sweepzaPipeline()    â”‚ Execute fu... â”‚  â”‚
â”‚  â”‚ Setup/Repair   â”‚ sweepzaSetup()       â”‚ Initialize... â”‚  â”‚
â”‚  â”‚ Refresh Map    â”‚ refreshSourceMapM... â”‚ Re-scan sh... â”‚  â”‚
â”‚  â”‚ Clear LLM Cacheâ”‚ clearLlmCache()      â”‚ Force re-e... â”‚  â”‚
â”‚  â”‚ Export CSV     â”‚ exportMasterToCsv()  â”‚ Download M... â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                              â”‚
â”‚  SYSTEM STATUS (read-only)                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Metric             â”‚ Value  â”‚ Last Upd...â”‚ Notes      â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚ Last Pipeline Run  â”‚ Never  â”‚            â”‚ See Swee...â”‚  â”‚
â”‚  â”‚ Enabled Sheets     â”‚ 0      â”‚            â”‚ Configure..â”‚  â”‚
â”‚  â”‚ Master Export Rows â”‚ 0      â”‚            â”‚ Total ro...â”‚  â”‚
â”‚  â”‚ LLM Queue Size     â”‚ N/A    â”‚            â”‚ Rows awa...â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                              â”‚
â”‚  ğŸ“‹ CONFIGURATION SHEETS                                     â”‚
â”‚  â€¢ Sweepza_Master_Adjust: Schema, prompts, limits           â”‚
â”‚  â€¢ Sweepza_Source_Map: Enable/disable sheets                â”‚
â”‚  â€¢ Sweepza_Logs: Execution details                          â”‚
â”‚  â€¢ Sweepza_Run_History: Per-run metrics                     â”‚
â”‚  â€¢ Sweepza_Delete_Audit: Deletion record                    â”‚
â”‚  â€¢ Sweepza_LLM_Cost_Tracking: Token usage                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ” Safety Features

**DRY_RUN mode**:
- Safe testing environment
- Logs show what would happen
- No actual data changes
- Perfect for experimenting

**Confirmation dialogs**:
- `clearLlmCache()` asks for confirmation
- Shows warning about OpenAI credits
- Can cancel before proceeding

**Status monitoring**:
- Track pipeline runs in real-time
- See exactly what's enabled
- Monitor row counts

---

## ğŸ“ Migration from v2.6

**Automatic**:
1. Copy new SweepzaAppScript.txt to Apps Script
2. Run `sweepzaSetup()` once
3. Control Panel auto-upgrades to v2.7 layout
4. All settings preserved

**Manual** (if needed):
- Old B2-B4 settings map to new B5-B7
- New features default to safe values (FALSE)
- No breaking changes

---

## ğŸ¯ Best Practices

### 1. Use DRY_RUN first
Before making major changes, test with DRY_RUN = TRUE

### 2. Check Source Map regularly
Run `refreshSourceMapManual()` after adding sheets to verify detection

### 3. Monitor status panel
Check "Last Pipeline Run" and row counts to verify everything works

### 4. Use FORCE_FULL_REFRESH sparingly
Only when needed - it re-enriches ALL rows (expensive)

### 5. Backup before major changes
Use `exportMasterToCsv()` to save Master state before experiments

---

## ğŸ› Troubleshooting

### Control Panel shows old layout
**Solution**: Run `sweepzaSetup()` to trigger upgrade

### Quick Actions don't work
**Solution**: Make sure you copied the full v2.7 code

### System Status not updating
**Solution**: Status updates after each pipeline run automatically

### FORCE_FULL_REFRESH not working
**Solution**: Check Sweepza_Logs - it will show "force refresh" in messages

---

**Version**: v2.7  
**Release**: December 18, 2025  
**Breaking Changes**: None - all backward compatible
